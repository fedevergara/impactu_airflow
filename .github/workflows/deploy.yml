name: Validate and Test DAGs

on:
  push:
    branches: [ "main" ]
    paths:
      - 'extract/**'
      - 'transform/**'
      - 'load/**'
      - 'dags/**'
      - 'impactu/**'
      - 'requirements.txt'
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-mock mongomock apache-airflow==3.1.0

      - name: Run DAG Integrity tests
        run: |
          export PYTHONPATH=$PYTHONPATH:.
          pytest tests/etl/test_dag_integrity.py

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files_yaml: |
            scimagojr:
              - extract/scimagojr/**
              - dags/extract_scimagojr.py

      - name: Run ScimagoJR tests
        if: steps.changed-files.outputs.scimagojr_any_changed == 'true'
        run: |
          export PYTHONPATH=$PYTHONPATH:.
          pytest tests/etl/test_scimagojr.py

  validate-on-dev:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Trigger PR Validation on Dev Airflow
        id: trigger_dag
        run: |
          echo "üöÄ Triggering validation for PR #${{ github.event.number }}..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://dev.airflow.colav.co/api/v2/dags/pr_validator/dagRuns" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.AIRFLOW_API_TOKEN }}" \
            -d '{
              "dag_run_id": "pr_${{ github.event.number }}_${{ github.run_number }}",
              "logical_date": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
              "conf": {
                "pr_number": ${{ github.event.number }},
                "github_token": "${{ secrets.GITHUB_TOKEN }}"
              }
            }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Failed to trigger DAG (HTTP $HTTP_CODE): $BODY"
            exit 1
          fi
          
          DAG_RUN_ID=$(echo "$BODY" | jq -r '.dag_run_id')
          echo "dag_run_id=$DAG_RUN_ID" >> $GITHUB_OUTPUT
          echo "‚úÖ Triggered: $DAG_RUN_ID"

      - name: Wait for Validation Results
        run: |
          DAG_RUN_ID="${{ steps.trigger_dag.outputs.dag_run_id }}"
          echo "‚è±Ô∏è Polling validation status for $DAG_RUN_ID..."
          
          MAX_ATTEMPTS=60  # 10 minutes max
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            RESPONSE=$(curl -s "https://dev.airflow.colav.co/api/v2/dags/pr_validator/dagRuns/$DAG_RUN_ID" \
              -H "Authorization: Bearer ${{ secrets.AIRFLOW_API_TOKEN }}")
            
            STATE=$(echo "$RESPONSE" | jq -r '.state')
            DURATION=$(echo "$RESPONSE" | jq -r '.duration // "running"')
            
            echo "  Status: $STATE | Duration: ${DURATION}s"
            
            if [ "$STATE" == "success" ]; then
              echo "‚úÖ Validation Passed!"
              break
            elif [ "$STATE" == "failed" ]; then
              echo "‚ùå Validation Failed!"
              echo ""
              echo "üìã Fetching validation logs..."
              curl -s "https://dev.airflow.colav.co/api/v2/dags/pr_validator/dagRuns/$DAG_RUN_ID/taskInstances/validate_pr/logs/1" \
                -H "Authorization: Bearer ${{ secrets.AIRFLOW_API_TOKEN }}" \
                | jq -r '.content[] | select(.event) | .event' \
                | grep -E "ERROR|FAILED|‚úó|‚ùå" || echo "$LOGS"
              exit 1
            elif [ "$STATE" == "null" ] || [ "$STATE" == "" ]; then
              echo "‚ö†Ô∏è Error fetching status"
              exit 1
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            sleep 10
          done
          
          if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
            echo "‚è±Ô∏è Timeout waiting for validation"
            exit 1
          fi

      - name: Post Validation Summary
        if: always()
        run: |
          DAG_RUN_ID="${{ steps.trigger_dag.outputs.dag_run_id }}"
          echo "üìä Full validation logs available at:"
          echo "https://dev.airflow.colav.co/dags/pr_validator/grid?dag_run_id=$DAG_RUN_ID"
